<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Publish New Post</title>
    <style>
        body { font-family: sans-serif; max-width: 600px; margin: 2rem auto; padding: 1rem; }
        input { width: 100%; padding: 8px; margin-bottom: 1rem; }
        button { padding: 10px 15px; cursor: pointer; }
        #status { margin-top: 1rem; font-style: italic; }
    </style>
</head>
<body>
    <h1>Publish New Post</h1>
    <p>Paste the public Google Doc link below. Ensure "Anyone with the link can view" is enabled.</p>
    <input type="text" id="gdoc-link" placeholder="https://docs.google.com/document/d/...">
    <button onclick="publishPost()">Publish</button>
    <div id="status"></div>

    <script>
        // --- Configuration ---
        // PASTE YOUR NEW, SECRET TOKEN HERE. KEEP THIS FILE LOCAL. DO NOT COMMIT IT TO GITHUB.
        const GITHUB_TOKEN = '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'; 
        const GITHUB_REPO = 'sandbox-escape/blog';
        const POSTS_DIR = '_posts';

        async function publishPost() {
            const docLink = document.getElementById('gdoc-link').value;
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = 'Processing...';

            if (!docLink.startsWith('https://docs.google.com/document/d/')) {
                statusDiv.textContent = 'Error: Invalid Google Doc link.';
                return;
            }

            const docId = docLink.split('/d/')[1].split('/')[0];
            const fetchUrl = `https://docs.google.com/document/d/${docId}/pub?embedded=true`;

            try {
                // 1. Fetch and Parse Google Doc HTML
                const response = await fetch(fetchUrl);
                if (!response.ok) throw new Error('Could not fetch Google Doc. Is it public?');
                const htmlText = await response.text();

                const parser = new DOMParser();
                const doc = parser.parseFromString(htmlText, 'text/html');
                const contentBody = doc.body;

                const title = contentBody.querySelector('h1')?.innerText || 'Untitled Post';
                const postData = {
                    title: title,
                    date: new Date().toISOString(),
                    content: []
                };

                contentBody.children.forEach(el => {
                    const tagName = el.tagName.toLowerCase();
                    if (['h1', 'h2', 'h3', 'h4', 'h5', 'h6'].includes(tagName)) {
                        postData.content.push({ type: tagName, text: el.innerText });
                    } else if (tagName === 'p') {
                        // Check for images inside paragraphs
                        const img = el.querySelector('img');
                        if (img && img.src) {
                            postData.content.push({ type: 'image', src: img.src, alt: img.alt });
                        } else if (el.innerText.trim() !== '') {
                            postData.content.push({ type: 'p', text: el.innerText });
                        }
                    }
                });

                // 2. Commit to GitHub
                const fileName = `${new Date().toISOString().split('T')[0]}-${title.toLowerCase().replace(/\s+/g, '-').replace(/[^\w-]+/g, '')}.json`;
                const filePath = `${POSTS_DIR}/${fileName}`;
                const fileContent = JSON.stringify(postData, null, 2);
                
                const commitMessage = `New blog post: ${title}`;
                const encodedContent = btoa(unescape(encodeURIComponent(fileContent))); // Base64 encode

                const githubUrl = `https://api.github.com/repos/${GITHUB_REPO}/contents/${filePath}`;
                
                const commitResponse = await fetch(githubUrl, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${GITHUB_TOKEN}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: commitMessage,
                        content: encodedContent
                    })
                });

                if (!commitResponse.ok) {
                    const error = await commitResponse.json();
                    throw new Error(`GitHub API error: ${error.message}`);
                }

                statusDiv.textContent = `Successfully published! File: ${fileName}`;
                document.getElementById('gdoc-link').value = '';

            } catch (error) {
                console.error(error);
                statusDiv.textContent = `Error: ${error.message}`;
            }
        }
    </script>
</body>
</html>
