<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>P2P Voice Call</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        @import url('https://rsms.me/inter/inter.css');
        .status-dot {
            height: 12px;
            width: 12px;
            border-radius: 50%;
            display: inline-block;
            animation: pulse 2s infinite;
        }
        .status-dot.offline {
            background-color: #f87171; /* red-400 */
        }
        .status-dot.connecting {
            background-color: #facc15; /* yellow-400 */
            animation: pulse 1s infinite;
        }
        .status-dot.online {
            background-color: #4ade80; /* green-400 */
            animation: none;
        }
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }
        #notification {
            transition: opacity 0.5s ease-in-out;
        }
    </style>
</head>
<body class="bg-gray-900 text-white flex items-center justify-center min-h-screen">

    <div class="w-full max-w-md p-8 space-y-6 bg-gray-800 rounded-2xl shadow-lg relative">
        <!-- Notification Area -->
        <div id="notification" class="absolute top-0 left-1/2 -translate-x-1/2 mt-4 px-4 py-2 rounded-lg text-white text-sm font-semibold opacity-0 pointer-events-none"></div>

        <div class="text-center">
            <h1 class="text-3xl font-bold text-white">P2P Voice Chat</h1>
            <p class="text-gray-400 mt-2">Connect directly with a friend using your voice.</p>
        </div>

        <!-- Status Indicator -->
        <div class="flex items-center justify-center space-x-2 pt-4">
            <span id="status-dot" class="status-dot offline"></span>
            <p id="status-text" class="text-gray-400">Status: Offline</p>
        </div>

        <!-- Your ID -->
        <div class="space-y-2">
            <label for="my-id" class="block text-sm font-medium text-gray-300">Your ID</label>
            <div class="flex items-center space-x-2">
                <input type="text" id="my-id" readonly class="w-full px-4 py-2 text-gray-200 bg-gray-700 border border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="Initializing...">
                <button id="copy-id-btn" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg text-white font-semibold transition-colors duration-200" title="Copy your ID">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                        <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2H6zm8 2V5a1 1 0 00-1-1H7a1 1 0 00-1 1v.083l.083.083L7.5 6.583A2 2 0 019 8h2a2 2 0 011.414 3.414l.586.586V5z" />
                    </svg>
                </button>
            </div>
            <p class="text-xs text-gray-500">Share this ID with your friend to start a call.</p>
        </div>

        <!-- Friend's ID -->
        <div class="space-y-2">
            <label for="friend-id" class="block text-sm font-medium text-gray-300">Friend's ID</label>
            <input type="text" id="friend-id" class="w-full px-4 py-2 text-gray-200 bg-gray-700 border border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="Enter friend's ID here">
        </div>

        <!-- Action Buttons -->
        <div class="flex flex-col sm:flex-row gap-4 pt-4">
            <button id="call-btn" class="w-full px-4 py-3 bg-green-600 hover:bg-green-700 rounded-lg text-white font-bold transition-colors duration-200 flex items-center justify-center space-x-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
                </svg>
                <span>Call</span>
            </button>
            <button id="end-call-btn" class="w-full px-4 py-3 bg-red-600 hover:bg-red-700 rounded-lg text-white font-bold transition-colors duration-200 flex items-center justify-center space-x-2" style="display: none;">
                 <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M16 8l2-2m0 0l2 2m-2-2v12a2 2 0 01-2 2H8a2 2 0 01-2-2V6l2-2m0 0l2 2m-2-2h8z" />
                </svg>
                <span>End Call</span>
            </button>
        </div>
        
        <!-- Hidden audio elements -->
        <audio id="localAudio" muted></audio>
        <audio id="remoteAudio" autoplay></audio>

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const myIdEl = document.getElementById('my-id');
            const copyIdBtn = document.getElementById('copy-id-btn');
            const friendIdEl = document.getElementById('friend-id');
            const callBtn = document.getElementById('call-btn');
            const endCallBtn = document.getElementById('end-call-btn');
            const localAudio = document.getElementById('localAudio');
            const remoteAudio = document.getElementById('remoteAudio');
            const statusDot = document.getElementById('status-dot');
            const statusText = document.getElementById('status-text');
            const notificationEl = document.getElementById('notification');

            let localStream;
            let currentCall;
            let notificationTimeout;
            
            // This configuration is updated for better Safari compatibility.
            // 1. `pingInterval`: Sends a heartbeat to the server more frequently 
            //    to prevent Safari from closing the connection due to inactivity.
            // 2. `sdpSemantics`: A standard setting for modern WebRTC that can improve
            //    cross-browser compatibility.
            const peer = new Peer({
                config: {
                    iceServers: [
                        { urls: 'stun:stun.l.google.com:19302' },
                        { urls: 'stun:stun1.l.google.com:19302' },
                    ],
                    sdpSemantics: 'unified-plan'
                },
                pingInterval: 3000 // Pings every 3 seconds
            });

            // --- PeerJS Event Listeners ---

            peer.on('open', (id) => {
                console.log('My peer ID is: ' + id);
                myIdEl.value = id;
                updateStatus('online', 'Status: Online, ready to call.');
            });

            peer.on('call', (call) => {
                console.log('Incoming call...');
                navigator.mediaDevices.getUserMedia({ video: false, audio: true })
                    .then(stream => {
                        localStream = stream;
                        localAudio.srcObject = stream;
                        
                        call.answer(stream);
                        
                        call.on('stream', (remoteStream) => {
                            console.log('Received remote stream.');
                            remoteAudio.srcObject = remoteStream;
                        });

                        currentCall = call;
                        updateUiForCall();
                        updateStatus('online', `Status: In call with ${call.peer}`);
                        currentCall.on('close', endCall);

                    }).catch(err => {
                        console.error('Failed to get local stream', err);
                        showNotification('Could not access microphone. Please check permissions.', true);
                    });
            });

            peer.on('error', (err) => {
                console.error('PeerJS error:', err);
                showNotification(`Error: ${err.message}. Please refresh.`, true);
                updateStatus('offline', `Status: Error - ${err.type}`);
            });
            
            peer.on('disconnected', () => {
                console.log('Peer disconnected from server. Attempting to reconnect...');
                updateStatus('connecting', 'Status: Reconnecting...');
                // This will automatically try to reconnect with the same ID.
                peer.reconnect();
            });

            // --- UI Event Listeners ---

            callBtn.addEventListener('click', () => {
                const friendId = friendIdEl.value.trim();
                if (!friendId) {
                    showNotification("Please enter a friend's ID.", true);
                    return;
                }

                console.log(`Calling ${friendId}...`);
                updateStatus('connecting', `Status: Calling ${friendId}...`);

                navigator.mediaDevices.getUserMedia({ video: false, audio: true })
                    .then(stream => {
                        localStream = stream;
                        localAudio.srcObject = stream;

                        const call = peer.call(friendId, stream);
                        
                        call.on('stream', (remoteStream) => {
                            console.log('Received remote stream from outgoing call.');
                            remoteAudio.srcObject = remoteStream;
                        });

                        currentCall = call;
                        updateUiForCall();
                        updateStatus('online', `Status: In call with ${friendId}`);
                        currentCall.on('close', endCall);

                    }).catch(err => {
                        console.error('Failed to get local stream', err);
                        showNotification('Could not access microphone. Please check permissions.', true);
                        updateStatus('online', 'Status: Online, ready to call.');
                    });
            });
            
            endCallBtn.addEventListener('click', () => {
                endCall();
            });

            copyIdBtn.addEventListener('click', () => {
                myIdEl.select();
                // A more modern approach might use navigator.clipboard, but execCommand has broader support
                // and is fine for this internal tool.
                document.execCommand('copy');
                showNotification("Copied ID!");
            });

            // --- Helper Functions ---

            function updateUiForCall() {
                callBtn.style.display = 'none';
                endCallBtn.style.display = 'flex';
                friendIdEl.disabled = true;
            }
            
            function resetUi() {
                callBtn.style.display = 'flex';
                endCallBtn.style.display = 'none';
                friendIdEl.disabled = false;
                friendIdEl.value = '';
            }

            function endCall() {
                console.log('Call ended.');
                if (currentCall) {
                    currentCall.close();
                    currentCall = null;
                }
                if (localStream) {
                    localStream.getTracks().forEach(track => track.stop());
                    localStream = null;
                }
                remoteAudio.srcObject = null;
                resetUi();
                updateStatus('online', 'Status: Online, ready to call.');
            }
            
            function updateStatus(state, text) {
                statusDot.className = `status-dot ${state}`;
                statusText.textContent = text;
            }

            function showNotification(message, isError = false) {
                // Clear any existing timeout
                if (notificationTimeout) {
                    clearTimeout(notificationTimeout);
                }

                notificationEl.textContent = message;
                notificationEl.className = `absolute top-0 left-1/2 -translate-x-1/2 mt-4 px-4 py-2 rounded-lg text-white text-sm font-semibold opacity-100 pointer-events-auto ${isError ? 'bg-red-500' : 'bg-blue-500'}`;

                // Hide the notification after 3 seconds
                notificationTimeout = setTimeout(() => {
                    notificationEl.style.opacity = '0';
                    notificationEl.classList.add('pointer-events-none');
                }, 3000);
            }
            
            updateStatus('connecting', 'Status: Connecting to server...');
        });
    </script>
</body>
</html>
